#include "renderer/renderer.h"

#include "text.h"

static uint8_t char_to_bitmap[][8] = {
    /* 0x20 ' ' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 0x21 '!' */ {0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00, 0x00},
    /* 0x22 '"' */ {0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 0x23 '#' */ {0x0A, 0x1F, 0x0A, 0x0A, 0x1F, 0x0A, 0x00, 0x00},
    /* 0x24 '$' */ {0x04, 0x0F, 0x14, 0x0E, 0x05, 0x1E, 0x04, 0x00},
    /* 0x25 '%' */ {0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03, 0x00},
    /* 0x26 '&' */ {0x0C, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0D, 0x00},
    /* 0x27 ''' */ {0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 0x28 '(' */ {0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0x00},
    /* 0x29 ')' */ {0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00},
    /* 0x2A '*' */ {0x00, 0x04, 0x15, 0x0E, 0x15, 0x04, 0x00, 0x00},
    /* 0x2B '+' */ {0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00, 0x00},
    /* 0x2C ',' */ {0x00, 0x00, 0x00, 0x00, 0x06, 0x04, 0x08, 0x00},
    /* 0x2D '-' */ {0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00},
    /* 0x2E '.' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00},
    /* 0x2F '/' */ {0x01, 0x02, 0x02, 0x04, 0x08, 0x08, 0x10, 0x00},
    /* 0x30 '0' */ {0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E, 0x00},
    /* 0x31 '1' */ {0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00},
    /* 0x32 '2' */ {0x0E, 0x11, 0x01, 0x06, 0x08, 0x10, 0x1F, 0x00},
    /* 0x33 '3' */ {0x0E, 0x11, 0x01, 0x06, 0x01, 0x11, 0x0E, 0x00},
    /* 0x34 '4' */ {0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02, 0x00},
    /* 0x35 '5' */ {0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E, 0x00},
    /* 0x36 '6' */ {0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E, 0x00},
    /* 0x37 '7' */ {0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08, 0x00},
    /* 0x38 '8' */ {0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E, 0x00},
    /* 0x39 '9' */ {0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C, 0x00},
    /* 0x3A ':' */ {0x00, 0x06, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00},
    /* 0x3B ';' */ {0x00, 0x06, 0x00, 0x00, 0x06, 0x04, 0x08, 0x00},
    /* 0x3C '<' */ {0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00},
    /* 0x3D '=' */ {0x00, 0x00, 0x1F, 0x00, 0x1F, 0x00, 0x00, 0x00},
    /* 0x3E '>' */ {0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08, 0x00},
    /* 0x3F '?' */ {0x0E, 0x11, 0x01, 0x06, 0x04, 0x00, 0x04, 0x00},
    /* 0x40 '@' */ {0x0E, 0x11, 0x17, 0x15, 0x17, 0x10, 0x0E, 0x00},
    /* 0x41 'A' */ {0x04, 0x0A, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x00},
    /* 0x42 'B' */ {0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E, 0x00},
    /* 0x43 'C' */ {0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E, 0x00},
    /* 0x44 'D' */ {0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C, 0x00},
    /* 0x45 'E' */ {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F, 0x00},
    /* 0x46 'F' */ {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10, 0x00},
    /* 0x47 'G' */ {0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0F, 0x00},
    /* 0x48 'H' */ {0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11, 0x00},
    /* 0x49 'I' */ {0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00},
    /* 0x4A 'J' */ {0x01, 0x01, 0x01, 0x01, 0x01, 0x11, 0x0E, 0x00},
    /* 0x4B 'K' */ {0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0x00},
    /* 0x4C 'L' */ {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F, 0x00},
    /* 0x4D 'M' */ {0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11, 0x00},
    /* 0x4E 'N' */ {0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x00},
    /* 0x4F 'O' */ {0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00},
    /* 0x50 'P' */ {0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10, 0x00},
    /* 0x51 'Q' */ {0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D, 0x00},
    /* 0x52 'R' */ {0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11, 0x00},
    /* 0x53 'S' */ {0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E, 0x00},
    /* 0x54 'T' */ {0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00},
    /* 0x55 'U' */ {0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00},
    /* 0x56 'V' */ {0x11, 0x11, 0x11, 0x11, 0x0A, 0x0A, 0x04, 0x00},
    /* 0x57 'W' */ {0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x11, 0x00},
    /* 0x58 'X' */ {0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11, 0x00},
    /* 0x59 'Y' */ {0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04, 0x00},
    /* 0x5A 'Z' */ {0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F, 0x00},
    /* 0x5B '[' */ {0x0E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00},
    /* 0x5C '\' */ {0x10, 0x08, 0x08, 0x04, 0x02, 0x02, 0x01, 0x00},
    /* 0x5D ']' */ {0x0E, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0E, 0x00},
    /* 0x5E '^' */ {0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 0x5F '_' */ {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x00},
    /* 0x60 '`' */ {0x08, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 0x61 'a' */ {0x00, 0x00, 0x0E, 0x01, 0x0F, 0x11, 0x0F, 0x00},
    /* 0x62 'b' */ {0x10, 0x10, 0x1E, 0x11, 0x11, 0x11, 0x1E, 0x00},
    /* 0x63 'c' */ {0x00, 0x00, 0x0E, 0x10, 0x10, 0x11, 0x0E, 0x00},
    /* 0x64 'd' */ {0x01, 0x01, 0x0F, 0x11, 0x11, 0x11, 0x0F, 0x00},
    /* 0x65 'e' */ {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00},
    /* 0x66 'f' */ {0x06, 0x09, 0x08, 0x1C, 0x08, 0x08, 0x08, 0x00},
    /* 0x67 'g' */ {0x00, 0x0F, 0x11, 0x11, 0x0F, 0x01, 0x0E, 0x00},
    /* 0x68 'h' */ {0x10, 0x10, 0x1E, 0x11, 0x11, 0x11, 0x11, 0x00},
    /* 0x69 'i' */ {0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x0E, 0x00},
    /* 0x6A 'j' */ {0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0C, 0x00},
    /* 0x6B 'k' */ {0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00},
    /* 0x6C 'l' */ {0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00},
    /* 0x6D 'm' */ {0x00, 0x00, 0x1A, 0x15, 0x15, 0x11, 0x11, 0x00},
    /* 0x6E 'n' */ {0x00, 0x00, 0x1E, 0x11, 0x11, 0x11, 0x11, 0x00},
    /* 0x6F 'o' */ {0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E, 0x00},
    /* 0x70 'p' */ {0x00, 0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x00},
    /* 0x71 'q' */ {0x00, 0x0F, 0x11, 0x11, 0x0F, 0x01, 0x01, 0x00},
    /* 0x72 'r' */ {0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0x00},
    /* 0x73 's' */ {0x00, 0x00, 0x0E, 0x10, 0x0E, 0x01, 0x1E, 0x00},
    /* 0x74 't' */ {0x08, 0x08, 0x1C, 0x08, 0x08, 0x09, 0x06, 0x00},
    /* 0x75 'u' */ {0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0D, 0x00},
    /* 0x76 'v' */ {0x00, 0x00, 0x11, 0x11, 0x11, 0x0A, 0x04, 0x00},
    /* 0x77 'w' */ {0x00, 0x00, 0x11, 0x15, 0x15, 0x15, 0x0A, 0x00},
    /* 0x78 'x' */ {0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x00},
    /* 0x79 'y' */ {0x00, 0x11, 0x11, 0x0F, 0x01, 0x11, 0x0E, 0x00},
    /* 0x7A 'z' */ {0x00, 0x00, 0x1F, 0x02, 0x04, 0x08, 0x1F, 0x00},
    /* 0x7B '{' */ {0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02, 0x00},
    /* 0x7C '|' */ {0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00},
    /* 0x7D '}' */ {0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08, 0x00},
    /* 0x7E '~' */ {0x08, 0x15, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00},
};

#define FONT_CHAR_WIDTH 6
#define FONT_CHAR_HEIGHT 8
#define FONT_FIRST_CHAR 0x20
#define FONT_LAST_CHAR 0x7E
#define FONT_BITMAP_COLS 5

static inline uint8_t a_of(pixel_t c)
{
  return (uint8_t)((c >> 24) & 0xFF);
}
static inline uint8_t r_of(pixel_t c)
{
  return (uint8_t)((c >> 16) & 0xFF);
}
static inline uint8_t g_of(pixel_t c)
{
  return (uint8_t)((c >> 8) & 0xFF);
}
static inline uint8_t b_of(pixel_t c)
{
  return (uint8_t)((c >> 0) & 0xFF);
}

static inline pixel_t pack_argb(uint8_t a, uint8_t r, uint8_t g, uint8_t b)
{
  return ((pixel_t)a << 24) | ((pixel_t)r << 16) | ((pixel_t)g << 8) | (pixel_t)b;
}

static inline pixel_t blend_src_over(pixel_t dst, pixel_t src)
{
  uint32_t sa = a_of(src);
  if (sa == 255)
    return src;
  if (sa == 0)
    return dst;

  uint32_t da = a_of(dst);

  uint32_t sr = r_of(src), sg = g_of(src), sb = b_of(src);
  uint32_t dr = r_of(dst), dg = g_of(dst), db = b_of(dst);

  uint32_t inv = 255 - sa;

  uint32_t or_ = (sr * sa + dr * inv) / 255;
  uint32_t og_ = (sg * sa + dg * inv) / 255;
  uint32_t ob_ = (sb * sa + db * inv) / 255;

  uint32_t oa = sa + (da * inv) / 255;

  return pack_argb((uint8_t)oa, (uint8_t)or_, (uint8_t)og_, (uint8_t)ob_);
}

static inline void put_pixel(pixel_t *pixels, size_t width, size_t height, int x, int y, pixel_t color)
{
  if ((unsigned)x >= width || (unsigned)y >= height)
    return;
  size_t idx = (size_t)y * width + (size_t)x;
  pixels[idx] = blend_src_over(pixels[idx], color);
}

static void draw_rect(pixel_t *pixels, size_t width, size_t height, int x, int y, int w, int h, pixel_t color)
{
  if (w <= 0 || h <= 0)
    return;
  for (int yy = 0; yy < h; ++yy)
    for (int xx = 0; xx < w; ++xx)
      put_pixel(pixels, width, height, x + xx, y + yy, color);
}

static void draw_char(pixel_t *pixels, size_t width, size_t height, int px, int py, char c, const text_style_t *st)
{
  if (c < FONT_FIRST_CHAR || c > FONT_LAST_CHAR)
    c = '?';

  int scale = st && st->scale > 0 ? st->scale : 1;
  pixel_t fg = st ? st->fg : 0xFFFFFFFF;
  pixel_t bg = st ? st->bg : 0x00000000;
  int draw_bg = st ? st->draw_bg : 0;

  const uint8_t *glyph = char_to_bitmap[(uint8_t)c - FONT_FIRST_CHAR];

  if (draw_bg && a_of(bg) != 0)
  {
    int cell_w = FONT_CHAR_WIDTH * scale;
    int cell_h = FONT_CHAR_HEIGHT * scale;
    draw_rect(pixels, width, height, px, py, cell_w, cell_h, bg);
  }

  for (int row = 0; row < FONT_CHAR_HEIGHT; row++)
  {
    uint8_t bits = glyph[row];
    for (int col = 0; col < FONT_BITMAP_COLS; col++)
    {
      if (bits & (1 << (FONT_BITMAP_COLS - 1 - col)))
      {
        int gx = px + col * scale;
        int gy = py + row * scale;

        for (int dy = 0; dy < scale; dy++)
          for (int dx = 0; dx < scale; dx++)
            put_pixel(pixels, width, height, gx + dx, gy + dy, fg);
      }
    }
  }
}

void text_draw(pixel_t *pixels, size_t width, size_t height, int x, int y, const char *text, const text_style_t *style)
{
  if (!pixels || !text)
    return;

  int scale = style && style->scale > 0 ? style->scale : 1;

  int origin_x = x;
  int cursor_x = x;
  int cursor_y = y;

  for (const char *p = text; *p; ++p)
  {
    char c = *p;

    if (c == '\n')
    {
      cursor_x = origin_x;
      cursor_y += FONT_CHAR_HEIGHT * scale;
      continue;
    }

    if (c == '\t')
    {
      cursor_x += FONT_CHAR_WIDTH * 4 * scale;
      continue;
    }

    draw_char(pixels, width, height, cursor_x, cursor_y, c, style);
    cursor_x += FONT_CHAR_WIDTH * scale;
  }
}
